/*

    XMon qubit. Anchor point is on the protect of the arm towards the resonator.

*/

    int JJ_pads_len = 5e3;


point addXmon(cell* curCell, point anchorPoint, string direction) {

        int JJ_delta_arm_len = 8e3;
        int JJ_arm_len = arm_len/2+JJ_delta_arm_len;
        point cursor;
        
    cursor.set(anchorPoint.x(), anchorPoint.y()-g_q);
    wire(curCell, protect, anchorPoint, "d", arm_len+2*g_q, w_q+2*g_q);
    wire(curCell, M, cursor, "d", arm_len/2+JJ_arm_len, w_q);

    cursor.set(cursor.x()-arm_len/2-g_q, cursor.y()-arm_len/2);
    wire(curCell, protect, cursor, "r", arm_len+2*g_q, w_q+2*g_q);
    cursor.set(cursor.x()+g_q, cursor.y());
    wire(curCell, M, cursor, "r", arm_len, w_q);
 //============ JJ pads ===========
   // =====  Top 
    cursor.set(cursor.x()+arm_len/2, cursor.y()-JJ_arm_len);
    point cursor2 = copyPoint(cursor); 
    wire(curCell, M, cursor, "d", JJ_pads_len/3, w_q/3);
    cursor.set(cursor.x()-w_q/3/2+w_q/3/3/2/2, cursor.y()-JJ_pads_len/3);
    wire(curCell, M, cursor, "d", JJ_pads_len*2/3, w_q/3/3/2);
    cursor.set(cursor.x()+w_q/3-w_q/3/3/2, cursor.y());
    wire(curCell, M, cursor, "d", JJ_pads_len*2/3, w_q/3/3/2);
    cursor.set(cursor.x()+w_q/3/3/2/2, cursor.y()-JJ_pads_len/3*2+JJ_pads_len/3/2);
    wire(curCell, M, cursor, "l", w_q/3/3, JJ_pads_len/3);
    cursor.set(cursor.x()-w_q/3, cursor.y());
    wire(curCell, M, cursor, "r", w_q/3/3, JJ_pads_len/3);
    
    wire(curCell, aux, cursor2, "d", JJ_pads_len*6/5, w_q/3);
    cursor2.set(cursor2.x()-w_q/3/2+w_q/3/3/2, cursor2.y()-JJ_pads_len);
    wire(curCell, aux, cursor2, "d", JJ_pads_len/2, 200);
    cursor2.set(cursor2.x()+w_q/3-w_q/3/3, cursor2.y());
    wire(curCell, aux, cursor2, "d", JJ_pads_len/2, 200);


  // =====  Bottom
    cursor.set(cursor.x()+w_q/3/2-w_q/4 , cursor.y()-(g_q-2*JJ_pads_len)+JJ_delta_arm_len-JJ_pads_len/3/2);
    point cursor2 = copyPoint(cursor);
    point cursor3 = copyPoint(cursor);
    cursor.set(cursor.x()-w_q/3/3/2+w_q/3/3/2/2, cursor.y());
    wire(curCell, M, cursor, "d", JJ_pads_len/3, w_q/3/3/2);
    cursor.set(cursor.x()+w_q/2+w_q/3/3/2, cursor.y());
    wire(curCell, M, cursor, "d", JJ_pads_len/3, w_q/3/3/2);
    
    cursor2.set(cursor2.x(), cursor2.y()-JJ_pads_len/3);
    wire(curCell, M, cursor2, "d", JJ_pads_len*2/3, w_q/3/3);
    cursor.set(cursor2.x()+w_q/2, cursor2.y());
    wire(curCell, M, cursor, "d", JJ_pads_len*2/3, w_q/3/3);
    
    wire(curCell, aux, cursor3, "d", JJ_pads_len/2, w_q/3/3);
    cursor3.set(cursor3.x()+w_q/2, cursor3.y());
    wire(curCell, aux, cursor3, "d", JJ_pads_len/2, w_q/3/3);
    cursor3.set(cursor3.x()-w_q/3/3/2, cursor3.y()-JJ_pads_len/3/2);
    wire(curCell, aux, cursor3, "l", JJ_pads_len/2, 300);
    cursor3.set(cursor3.x()-w_q/2+w_q/3/3, cursor3.y());
    wire(curCell, aux, cursor3, "r", JJ_pads_len/2, 300);
    
 // ==== Merge aux structure to M1       
    layout->booleanTool->boolOnLayer(aux, aux, M1, "A+B", 0, 0, 2);
    curCell->deselectAll();
    curCell->selectLayer(aux);
    curCell->deleteSelect();
// ========Rotation =========
    rect selection;
    selection.set(anchorPoint.x() - g_q-w_q/2, anchorPoint.y()-2*g_q-arm_len, 
                 anchorPoint.x()+g_q+w_q/2, anchorPoint.y());
    
    rotateSelection(curCell, selection, anchorPoint, direction);
    
    rect selection;
    selection.set(anchorPoint.x() - (arm_len/2+g_q), anchorPoint.y()-arm_len/2-g_q-w_q/2-g_q, 
                 anchorPoint.x()+(arm_len/2+g_q), anchorPoint.y()-arm_len/2-g_q+w_q/2+g_q);
    
    rotateSelection(curCell, selection, anchorPoint, direction);
    point retPoint;
    retPoint.set(0, -arm_len-2*g_q);
    return rotateVector(retPoint, anchorPoint, direction);
}
